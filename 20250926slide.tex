\documentclass[aspectratio=169,dvipdfmx,12pt,notheorems]{beamer}
%%%% 和文用 %%%%%
\usepackage{bxdpx-beamer}
\usepackage{pxjahyper}
\usepackage{minijs}%和文用
\renewcommand{\kanjifamilydefault}{\gtdefault}%和文用

%%%% スライドの見た目 %%%%%
\usetheme{Madrid}
\usefonttheme{professionalfonts}
\setbeamertemplate{frametitle}[default][center]
\setbeamertemplate{navigation symbols}{}
\setbeamercovered{transparent}%好みに応じてどうぞ）
\setbeamertemplate{blocks}[rounded]
\useinnertheme{circles}
\setbeamertemplate{footline}[page number]
\setbeamerfont{footline}{size=\normalsize,series=\bfseries}
\setbeamercolor{footline}{fg=black,bg=black}
%%%%

%%%% 定義環境 %%%%%
\usepackage{amsmath,amssymb}
\usepackage{amsthm}
\theoremstyle{definition}
\newtheorem{theorem}{定理}
\newtheorem{definition}{定義}
\newtheorem{proposition}{命題}
\newtheorem{lemma}{補題}
\newtheorem{corollary}{系}
\newtheorem{conjecture}{予想}
\newtheorem*{remark}{Remark}
\renewcommand{\proofname}{}
%%%%%%%%%

%%%%% フォント基本設定 %%%%%
\usepackage[T1]{fontenc}%8bit フォント
\usepackage{textcomp}%欧文フォントの追加
\usepackage[utf8]{inputenc}%文字コードをUTF-8
\usepackage[deluxe]{otf}%otfパッケージ
\usepackage{lxfonts}%数式・英文ローマン体を Lxfont にする
\usepackage{bm}%数式太字
%%%%%%%%%%

%%%%% PythonTeX %%%%%
\usepackage[makestderr]{pythontex}
\restartpythontexsession{\thesection}

\usepackage{ulem}
 
\title{明日からgraphlib、みんなで使おう}
\author[Hayao]{Hayao Suzuki}
\institute[PyCon JP 2025]{PyCon JP 2025 at International Conference Center Hiroshima}
%\titlegraphic{\includegraphics[scale=0.2]{pyconlogo.png}}
\date{September 26, 2025}

\begin{document}

\begin{frame}[plain]\frametitle{}
\titlepage %表紙
\end{frame}

\begin{frame}\frametitle{Share it}

\begin{block}{GitHub}
\begin{itemize}
\item \url{https://github.com/HayaoSuzuki/pyconjp2025}
\end{itemize}
\end{block}

\begin{block}{Hashtag}
\begin{itemize}
\item \#pyconjp \#PyConJP2025
\end{itemize}
\end{block}

\end{frame}

\section{自己紹介}

\begin{frame}\frametitle{Who am I ?}

\begin{block}{お前誰よ}
\begin{description}
\item[Name] Hayao Suzuki（鈴木　駿）
\item[\xout{Twitter} X] \href{https://twitter.com/CardinalXaro}{@CardinalXaro}
\item[Work] ソフトウェアエンジニア at 東京ガス株式会社
\end{description}
\end{block}

\begin{block}{東京ガス株式会社について}
\begin{itemize}
\item 一都六県に都市ガス・電気などのエネルギーを供給する会社
\item 東京ガスはPyCon JP 2025のGoldスポンサーです
\item ソフトウェアエンジニアを\structure{絶賛募集中} \url{https://www.tokyo-gas-recruit.com/career/}
\end{itemize}
\end{block}

\end{frame}

\begin{frame}\frametitle{Who am I ?}

\begin{block}{翻訳}
\begin{itemize}
\item \structure{Effective Python 第3版}(O'Reilly Japan) \structure{New!}
\item \structure{ハイパーモダンPython}(O'Reilly Japan)
\item \structure{Python Distilled}(O'Reilly Japan)
\end{itemize}
\end{block}

\begin{block}{監訳・監修}
\begin{itemize}
\item \structure{ロバストPython}(O'Reilly Japan) 
\item \structure{入門Python 3 第2版}(O'Reilly Japan)
\item \structure{Pythonクイックリファレンス 第4版}(O'Reilly Japan)
\end{itemize}
\end{block}

\end{frame}

\begin{frame}\frametitle{Who am I ?}

\begin{block}{過去の発表（抜粋）}
\begin{itemize}
\item \structure{Let's implement useless Python objects}(PyCon APAC 2023)
\item \structure{組み込み関数powの知られざる進化}(PyCon JP 2021)
\item \structure{インメモリーストリーム活用術}(PyCon JP 2020)
\item \structure{君はcmathを知っているか}(PyCon mini Shizuoka 2020)
\item \structure{Pythonと楽しむ初等整数論}(PyCon mini Hiroshima 2019)
\item \structure{SymPyによる数式処理}(PyCon JP 2018)
\end{itemize}
\end{block}
一覧は \url{https://xaro.hatenablog.jp/} を参照してください
\end{frame}

\section{概念の定義}

\subsection{導入}

\begin{frame}\frametitle{Today's Theme}

\begin{center}
\Huge{明日から\structure{\texttt{graphlib}}、みんなで使おう}
\end{center}

\end{frame}

\begin{frame}\frametitle{Executive Summary}

\begin{block}{忙しい人向けの要約}
\begin{itemize}
\item トポロジカルソートとは、有向非巡回グラフの頂点集合の線型順序である
\item \texttt{graphlib}は、トポロジカルソートが実装された標準ライブラリである
\item \texttt{graphlib}は、簡易的なタスクランナーとして使える
\end{itemize}
\end{block}

\end{frame}

\subsection{グラフの定義}

\begin{frame}\frametitle{グラフって、何？}

\begin{definition}[無向グラフ]
有限集合$V$および$V\times V$の\structure{非順序対}からなる集合の部分集合$E$の組$G=(V, E)$を\structure{無向グラフ}と呼ぶ。
\end{definition}

\begin{definition}[有向グラフ]
有限集合$V$および$V\times V$の\structure{順序対}からなる集合の部分集合$E$の組$G=(V, E)$を\structure{有向グラフ}と呼ぶ。
\end{definition}

\begin{itemize}
\item $V$を\structure{頂点集合}、$E$を\structure{辺集合}と呼ぶ。
\item $V$の要素を$G$の\structure{頂点}、$E$の要素を$G$の\structure{辺}と呼ぶ。
\end{itemize}

\end{frame}

\begin{frame}\frametitle{無向グラフの例}

\begin{center}
\includegraphics[width=8cm]{graph.png}
\end{center}

\end{frame}

\begin{frame}\frametitle{有向グラフの例}

\begin{center}
\includegraphics[width=15cm]{dag_example.png}
\end{center}

\end{frame}

%\begin{frame}\frametitle{有向グラフの例おかわり}
%
%\begin{center}
%\includegraphics[width=15cm]{non_dag_example.png}
%\end{center}
%
%\end{frame}

\begin{frame}\frametitle{つまり…どういうことだってばよ？}

\begin{center}
\Huge{…で、その\structure{グラフ}は当社で働くうえで \\ 何のメリットがあるとお考えですか？}
\end{center}

\end{frame}

\begin{frame}\frametitle{来いよベネット！定義なんか捨ててかかって来い！}

\begin{block}{忙しい人向けのグラフ}
\begin{itemize}
\item グラフとは、「もの」とその「関係」を数学的にモデル化したものである
\item 「もの」は人間、駅、タスク、サーバなど
\item 「関係」は人間関係、線路、依存関係、ネットワークなど
\end{itemize}
\end{block}

\end{frame}

\subsection{トポロジカルソートの定義}

\begin{frame}\frametitle{トポロジカルソートって、何？}

\begin{definition}[二項関係]
集合$A$の直積$A\times A$の部分集合$R$を\structure{二項関係}と呼ぶ。 \\
また、$(a, b) \in R$を$aRb$と表す。
\end{definition}

\begin{definition}[半順序関係]
以下の性質を満たす関係$R$を\structure{半順序関係}と呼ぶ。
\begin{description}
\item[反射律] $\forall a \in A$に対して、$aRa$である
\item[反対称律] $a, b \in A$に対して、$aRb$かつ$bRa$ならば$a=b$である
\item[推移律] $a, b, c \in A$に対して、$aRb$ かつ $bRc$ならば$aRc$である
\end{description}
\end{definition}
半順序関係は、大小関係や比較の概念を抽象したもの。
\end{frame}

\begin{frame}\frametitle{トポロジカルソートって、何？}

\begin{definition}[線型順序]
集合$A$の半順序関係$R$において、$\forall a, b \in A$に対して$aRb$または$bRa$が成り立つならば、$R$は\structure{線型順序}であると呼ぶ。
\end{definition}

\begin{definition}[トポロジカルソート]
有向グラフ$G=(V, E)$の\structure{トポロジカルソート}とは、$V$の線型順序$(V, \leq)$で、$(u, v) \in E$ならば$u \leq v$を満たすものである。
\end{definition}

\end{frame}

\begin{frame}\frametitle{トポロジカルソートって、何？}

\begin{definition}[歩道]
グラフ$G=(V, E)$の頂点$u_{1}$から$u_{k}$への長さ$k$の\structure{歩道}$W$とは、頂点の列$(u_{1}, u_{2}, \dots, u_{k})$で、$(u_{i}, u_{j}) \in E (1 \leq i < j \leq k)$を満たすものである。特に、$u_{1}=u_{k}$の場合、$W$\structure{閉じている}と呼ぶ。
\end{definition}

\begin{definition}[道]
グラフ$G=(V, E)$の歩道$W$において、頂点および辺がすべて異なるものは\structure{道}と呼ぶ。
特に、閉じた道を\structure{閉路}と言う。
\end{definition}

\begin{definition}[有向非巡回グラフ]
有向グラフ$G=(V, E)$において、閉路を含まないものを\structure{有向非巡回グラフ}と呼ぶ。
\end{definition}

\end{frame}

\begin{frame}\frametitle{トポロジカルソートって、何？}

\begin{proposition}[トポロジカルソート可能]
有向グラフ$G$が\structure{トポロジカルソート可能}であるための必要十分条件は、\\ 有向グラフ$G$が\structure{有向非巡回グラフ}であることである。
\end{proposition}

\end{frame}

\begin{frame}\frametitle{楽しい証明コーナー}

\begin{proof}[トポロジカルソート可能 $\Rightarrow$ 有向非巡回グラフ]
トポロジカルソート可能だがグラフ$G$に閉路が存在すると仮定する。 \\
その閉路を$v_{i}, v_{j}, v_{k}(i < j < k)$として、かつ$ v_{i} \leq v_{j} \leq v_{k}$とする。
$v_{i}, v_{j}, v_{k}(i < j < k)$は閉路なので、$v_{k}$から$v_{i}$への辺が存在する。 \\
つまり、$v_{k} \leq v_{i}$となるが、それは仮定$ v_{i} \leq v_{j} \leq v_{k}$に矛盾する。
\end{proof}

\end{frame}

\begin{frame}\frametitle{まだまだ続くぞ楽しい証明コーナー}

\begin{lemma}
有向非巡回グラフには入次数0の頂点が必ず存在する。
\end{lemma}

\begin{proof}[証明]
有向非巡回グラフの最長の道$v_{1}, \dots, v_{k}$を1つ選ぶ。
$v_{1}$に入る辺が存在するならば、$u, v_{1}, \dots, v_{k}$かつ$(u, v_{1}) \in E$のような頂点$u$が存在することになるが、$v_{1}, \dots, v_{k}$が最長の道であるという仮定に反する。
よって、$v_{1}$の入次数は0となり、有向非巡回グラフには入次数0の頂点が必ず存在する。
\end{proof}

\end{frame}

\begin{frame}\frametitle{え？まだあるんですか？楽しい証明コーナー}

\begin{lemma}
有向非巡回グラフ$G$から入次数0の頂点およびそこから出る辺を取り除いた部分グラフ$H$もまた有向非巡回グラフである。
\end{lemma}

\begin{proof}[証明]
部分グラフ$H$が有向非巡回グラフではないと仮定する。
$H$の閉路を$C$とした場合、$H$の構成方法から$C$には取り除いた入次数0の頂点およびそこから出る辺は含まれない。
つまり、$H$は$G$の部分グラフなので、閉路$C$は$G$にも存在することになる。
しかし、それは$G$が有向非巡回グラフであるという仮定に反する。
\end{proof}

\end{frame}

\begin{frame}\frametitle{楽しいよな！証明コーナー}

\begin{proof}[有向非巡回グラフ $\Rightarrow$ トポロジカルソート可能]
有向非巡回グラフ$G$には必ず入次数0の頂点が必ず存在するので、その頂点およびそこから出る辺を取り除く。
取り除いたグラフもまた有向非巡回グラフなので、頂点がなくなるまでそれを繰り返す。
取り除いた順番に頂点を並べたものがトポロジカルソートである。
\end{proof}
\structure{重要}：証明がアルゴリズムになっていることに注意。

\end{frame}

\begin{frame}\frametitle{今日はPyCon JP 2025の1日目です}

\begin{center}
\Huge{離散数学の講義ではなく、 \\ PyCon JPですよ}
\end{center}

\end{frame}

\begin{frame}\frametitle{来いよベネット！証明なんか捨てて（ｒｙ}

\begin{block}{忙しい人向けのトポロジカルソート}
\begin{itemize}
\item 半順序関係は、大小関係や包含関係を抽象化したもの
\item 線型順序は、どれでも比較できるやつ、ぐらいの理解で
\item トポロジカルソートは、有向グラフの頂点をいい感じに順序付けしたもの
\item トポロジカルソートと有向非巡回グラフは表裏一体
\item トポロジカルソートに関する証明がアルゴリズムになっている
\end{itemize}
\end{block}

\end{frame}

\section{実用例}

\begin{frame}\frametitle{トポロジカルソートの使い道とは}

\begin{exampleblock}{Q: 頂点をタスク、辺をタスクの依存関係とする。 \\ どの順番でタスクを実行すればよいか？}
\begin{center}
\includegraphics[width=8cm]{complex_dag_example.png}
\end{center}
\end{exampleblock}

\end{frame}

\begin{frame}\frametitle{トポロジカルソートの使い道とは}

\begin{block}{Ans: グラフをトポロジカルソートして、その順番にやればよい。}
A→B→D→E→C→G→F→I→M→H→J→K→L→N
\end{block}

\end{frame}

\begin{frame}\frametitle{どうやったの？}

\begin{center}
\Huge{すでに\structure{graphlib}、僕は使ったよ}
\end{center}

\end{frame}

\begin{frame}\frametitle{真打登場}

\begin{block}{\texttt{graphlib}：グラフ構造を操作する機能}
\begin{itemize}
\item 現在は\texttt{TopologicalSorter}のみ、単純な標準ライブラリ
\item Python 3.9で追加
\item \url{https://github.com/python/cpython/issues/61207}で議論されていた。
\end{itemize}
\end{block}

\end{frame}

\begin{frame}[fragile]\frametitle{\texttt{graphlib}の使い方}
\begin{exampleblock}{トポロジカルソートの実行}
\begin{pyverbatim}
from graphlib import TopologicalSorter

graph = {
    "D": {"B", "C"}, 
    "C": {"A"},
    "B": {"A"},
}
order = TopologicalSorter(graph).static_order()
print(f"Topological order: {" → ".join(order)}")
# A → C → B → D
\end{pyverbatim}
\end{exampleblock}
D$\leftarrow$B, D$\leftarrow$Cのようなイメージで定義する。
\end{frame}

\begin{frame}[fragile]\frametitle{\texttt{graphlib}の使い方}
\begin{alertblock}{有向非巡回グラフではないケース}
\begin{pyverbatim}
from graphlib import TopologicalSorter

graph = {
    "A": {"C"},
    "B": {"A"},
    "C": {"B"}
}
order = TopologicalSorter(graph).static_order()
print(f"Topological order: {" → ".join(order)}")
# graphlib.CycleErrorが発生する
\end{pyverbatim}
\end{alertblock}
\end{frame}

\begin{frame}\frametitle{より高度な使い方}

\begin{block}{\texttt{graphlib}：依存関係のあるタスクを実行するタスクランナー}
\begin{itemize}
\item 並列実行しやすいアルゴリズム
\item ドキュメントにそれとなく触れられているが、不十分...。
\item 生成AIの力を借りてそれとなく作ってみよう！
\end{itemize}
\end{block}

\end{frame}

\begin{frame}[fragile]\frametitle{タスクの定義}
\begin{block}{\texttt{dataclass}によるタスク定義}
\begin{pyverbatim}
@dataclass(frozen=True, slots=True)
class Task:
    name: str
    action: Action
    deps: set[str] = field(default_factory=set)
\end{pyverbatim}
\end{block}
頂点はハッシュ可能である必要があるので、\texttt{frozen=True}を使う。
\end{frame}

\begin{frame}[fragile]\frametitle{タスクランナー}
\begin{block}{グラフの定義}
\begin{pyverbatim}
def run(tasks, max_workers=None):
    by_name = {t.name: t for t in tasks}
    ts = TopologicalSorter({t.name: set(t.deps) for t in tasks})
    ts.prepare()
    results: dict[str, object] = {}
    ...
\end{pyverbatim}
\end{block}
\end{frame}

\begin{frame}[fragile]\frametitle{タスクランナー}
\begin{block}{並行処理：スレッドに投入}
\begin{pyverbatim}
def run(tasks, max_workers=None):
    ...
    with ThreadPoolExecutor(max_workers) as pool:
        while ts.is_active():
            ready = ts.get_ready()
            futs = {}
            for name in ready:
                print(f"run  {name}")
                futs[pool.submit(by_name[name].action)] = name
                ...
\end{pyverbatim}
\end{block}
\end{frame}

\begin{frame}[fragile]\frametitle{タスクランナー}
\begin{block}{並行処理：完了待ち}
\begin{pyverbatim}
def run(tasks, max_workers=None):
    ...
    with ThreadPoolExecutor(max_workers) as pool:
        while ts.is_active():
            ...
            for fut in as_completed(futs):
                name = futs[fut]
                results[name] = fut.result()
                print(f"done {name}")
                ts.done(name)
    return results
\end{pyverbatim}
\end{block}
\end{frame}

\begin{frame}\frametitle{まとめ}

\begin{block}{まとめ}
\begin{itemize}
\item トポロジカルソートとは、有向非巡回グラフの頂点集合の線型順序である。
\item 有向グラフ$G$が\structure{トポロジカルソート可能}であるための必要十分条件は、\\ 有向グラフ$G$が\structure{有向非巡回グラフ}であることである。
\item \texttt{graphlib}は、トポロジカルソートが実装された標準ライブラリである。
\item \texttt{graphlib}は、簡易的なタスクランナーを実装する際に、実行順序を決定する仕組みとして使える。
\end{itemize}
\end{block}

\end{frame}

\end{document}